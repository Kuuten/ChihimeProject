using DG.Tweening;
using NaughtyAttributes;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using TMPro;
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.InputSystem;
using UnityEngine.UI;
using UnityEngine.Video;

//--------------------------------------------------------------
//
//  魂バート弾選択シーンクラス
//
//--------------------------------------------------------------
public class SelectConvertManager : MonoBehaviour
{
    //  魂バート弾ボタン
    [SerializeField,EnumIndex(typeof(BossType))]
    private Button[] BossButton;

    //  メニューボタンのインデックス
    private int menuIndex;

    //  説明動画の背景オブジェクト
    [SerializeField] private GameObject explanationMovieBack;

    //  説明テキスト
    [SerializeField,EnumIndex(typeof(BossType))]
    private GameObject[] explanationTextObj;

    [SerializeField] private FadeIO Fade;               //  FadeIO
    [SerializeField] private ScrollAnimation Scroll;    //  巻物
    [SerializeField] private GameObject soundManager;   //  SoundManager

    //  魂バート用の動画クリップ
    [SerializeField,EnumIndex(typeof(BossType))]

    private VideoClip[] videoClip;
    //  魂バート用の動画プレイヤー
    [SerializeField] private VideoPlayer videoPlayer;

    bool bCanDecision;  //  ボタンの決定可能フラグ

    PlayerInput _input;
    InputAction navigate;
    float verticalInput;

    //  前回選択されていたオブジェクト
    private GameObject preSelectedObject;

    IEnumerator Start()
    {
        //  StageIdManagerがない時は生成する
        if (!GameObject.Find("SoundManager"))
        {
            Debug.Log("SoundManagerがないので生成します");
            Instantiate(soundManager);
        }

        //  ボタンの数チェック
        if(BossButton.Length > (int)BossType.Max)
        {
            Debug.LogError("BossButtonの数がBossType.Maxを上回っています");
        }

        _input = GetComponent<PlayerInput>();
        navigate =  _input.actions["Navigate"];
        verticalInput = default;
        menuIndex = (int)BossType.Douji;

        /* 〜〜〜〜〜〜〜〜〜〜〜演出の開始〜〜〜〜〜〜〜〜〜〜〜 */

        //  フェードイン
        yield return StartCoroutine(WaitingForFadeIn());

        yield return new WaitForSeconds(1); //  1秒待つ

        //  巻物を開くアニメーション
        yield return StartCoroutine(WaitingForOpeningScroll());

        yield return new WaitForSeconds(2.0f); //  2秒待つ

        /* 〜〜〜〜〜〜〜〜〜〜〜演出の終了〜〜〜〜〜〜〜〜フラグ〜〜〜 */

        //  BGM再生
        SoundManager.Instance.PlayBGM((int)MusicList.BGM_SELECTCONVERT);

        //  最初はドウジを選択状態にする
        EventSystem.current.SetSelectedGameObject(BossButton[(int)BossType.Douji].gameObject);
        preSelectedObject = BossButton[(int)BossType.Douji].gameObject;
        UpdateButtonScale(BossButton[(int)BossType.Douji].gameObject);

        //  動画と動画の枠を表示する
        explanationMovieBack.SetActive(true);

        //  決定可能フラグON
        bCanDecision = true;

    }

    void Update()
    {
        if(!bCanDecision)return;

        //  3Dメニューを回転させる
        RotateMenu();

        //  選択ボタンによって説明動画を再生する
        PlayExplanationMovie();

        //  今回選択されているオブジェクトが前回と違ったらSE再生
        if(preSelectedObject != EventSystem.current.currentSelectedGameObject)
        {
            //  セレクトSE再生
            SoundManager.Instance.PlaySFX((int)AudioChannel.SFX, (int)SFXList.SFX_TITLE_SELECT);
        }

        //  今回選択されたオブジェクトを保存
        preSelectedObject = EventSystem.current.currentSelectedGameObject;
    }

    //  現在のステージNo.によって次の遷移先を決める
    private void LoadNextScene()
    {
        //  BGMを止める
        SoundManager.Instance.Stop((int)AudioChannel.MUSIC);


        if(PlayerInfoManager.stageInfo == PlayerInfoManager.StageInfo.Stage01)
        {
            //  Introシーンへ
            LoadingScene.Instance.LoadNextScene("Intro");
        }
        else if(PlayerInfoManager.stageInfo == PlayerInfoManager.StageInfo.Stage02)
        {
            //  ステージ２へ
            LoadingScene.Instance.LoadNextScene("Stage02");
        }
        else if(PlayerInfoManager.stageInfo == PlayerInfoManager.StageInfo.Stage03)
        {
            //  ステージ３へ
            LoadingScene.Instance.LoadNextScene("Stage03");
        }
        else if(PlayerInfoManager.stageInfo == PlayerInfoManager.StageInfo.Stage04)
        {
            //  ステージ４へ
            LoadingScene.Instance.LoadNextScene("Stage04");
        }
        else if(PlayerInfoManager.stageInfo == PlayerInfoManager.StageInfo.Stage05)
        {
            //  ステージ５へ
            LoadingScene.Instance.LoadNextScene("Stage05");
        }
        else if(PlayerInfoManager.stageInfo == PlayerInfoManager.StageInfo.Stage06)
        {
            //  ステージ６へ
            LoadingScene.Instance.LoadNextScene("Stage06");
        }
    }

    //  ドウジボタンを押下した時
    public void OnDoujiButtonDown()
    {
        //  決定可能フラグがfalseならリターン
        if(!bCanDecision)return;

        //  ボタンを無効化
        for(int i=0;i<(int)BossType.Max;i++)
        {
            BossButton[i].GetComponent<Button>().enabled = false;
        }

        //  決定音再生
        SoundManager.Instance.PlaySFX(
            (int)AudioChannel.SFX, (int)SFXList.SFX_TITLE_DECISION);

        //  巻物を閉じるアニメーションの完了を待つ
        StartCoroutine(WaitingForClosingScroll());
    
        //  魂バート弾をセット
        PlayerInfoManager.g_CONVERTSHOT = SHOT_TYPE.DOUJI;

        //  次のシーンをロード
        LoadNextScene();
    }

    //  ツクモボタンを押下した時
    public void OnTsukumoButtonDown()
    {
        //  決定可能フラグがfalseならリターン
        if(!bCanDecision)return;

        //  ボタンを無効化
        for(int i=0;i<(int)BossType.Max;i++)
        {
            BossButton[i].GetComponent<Button>().enabled = false;
        }

        //  決定音再生
        SoundManager.Instance.PlaySFX(
            (int)AudioChannel.SFX, (int)SFXList.SFX_TITLE_DECISION);

        //  巻物を閉じるアニメーションの完了を待つ
        StartCoroutine(WaitingForClosingScroll());
    
        //  魂バート弾をセット
        PlayerInfoManager.g_CONVERTSHOT = SHOT_TYPE.TSUKUMO;

        //  次のシーンをロード
        LoadNextScene();
    }


    //  クチナワボタンを押下した時
    public void OnKuchinawaButtonDown()
    {
        //  決定可能フラグがfalseならリターン
        if(!bCanDecision)return;

        //  ボタンを無効化
        for(int i=0;i<(int)BossType.Max;i++)
        {
            BossButton[i].GetComponent<Button>().enabled = false;
        }

        ////  決定音再生
        //SoundManager.Instance.PlaySFX(
        //    (int)AudioChannel.SFX, (int)SFXList.SFX_TITLE_DECISION);

        ////  巻物を閉じるアニメーションの完了を待つ
        //StartCoroutine(WaitingForClosingScroll());
    
        ////  魂バート弾をセット
        //PlayerInfoManager.g_CONVERTSHOT = SHOT_TYPE.KUCHINAWA;


        //  決定不可SEを鳴らす
        OnNotImplementedButtonDown();
    }


    //  クラマボタンを押下した時
    public void OnKuramaButtonDown()
    {
        //  決定可能フラグがfalseならリターン
        if(!bCanDecision)return;

        //  ボタンを無効化
        for(int i=0;i<(int)BossType.Max;i++)
        {
            BossButton[i].GetComponent<Button>().enabled = false;
        }

        ////  決定音再生
        //SoundManager.Instance.PlaySFX(
        //    (int)AudioChannel.SFX, (int)SFXList.SFX_TITLE_DECISION);

        ////  巻物を閉じるアニメーションの完了を待つ
        //StartCoroutine(WaitingForClosingScroll());
    
        ////  魂バート弾をセット
        //PlayerInfoManager.g_CONVERTSHOT = SHOT_TYPE.KURAMA;


        //  決定不可SEを鳴らす
        OnNotImplementedButtonDown();
    }


    //  ワダツミボタンを押下した時
    public void OnWadatsumiButtonDown()
    {
        //  決定可能フラグがfalseならリターン
        if(!bCanDecision)return;

        //  ボタンを無効化
        for(int i=0;i<(int)BossType.Max;i++)
        {
            BossButton[i].GetComponent<Button>().enabled = false;
        }

        ////  決定音再生
        //SoundManager.Instance.PlaySFX(
        //    (int)AudioChannel.SFX, (int)SFXList.SFX_TITLE_DECISION);

        ////  巻物を閉じるアニメーションの完了を待つ
        //StartCoroutine(WaitingForClosingScroll());
    
        ////  魂バート弾をセット
        //PlayerInfoManager.g_CONVERTSHOT = SHOT_TYPE.WADATSUMI;

        //  決定不可SEを鳴らす
        OnNotImplementedButtonDown();
    }

    //  ハクメンボタンを押下した時
    public void OnHakumenButtonDown()
    {
        //  決定可能フラグがfalseならリターン
        if(!bCanDecision)return;

        //  ボタンを無効化
        for(int i=0;i<(int)BossType.Max;i++)
        {
            BossButton[i].GetComponent<Button>().enabled = false;
        }

        ////  決定音再生
        //SoundManager.Instance.PlaySFX(
        //    (int)AudioChannel.SFX, (int)SFXList.SFX_TITLE_DECISION);

        ////  巻物を閉じるアニメーションの完了を待つ
        //StartCoroutine(WaitingForClosingScroll());
    
        ////  魂バート弾をセット
        //PlayerInfoManager.g_CONVERTSHOT = SHOT_TYPE.WADATSUMI;

        //  決定不可SEを鳴らす
        OnNotImplementedButtonDown();
    }

    // フェードインの完了を待つ
    IEnumerator WaitingForFadeIn()
    {
        yield return StartCoroutine(Fade.StartFadeIn());
    }

    // フェードアウトの完了を待つ
    IEnumerator WaitingForFadeOut()
    {
        yield return StartCoroutine(Fade.StartFadeOut());
    }

    //  巻物を開くアニメーションの完了を待つ
    IEnumerator WaitingForOpeningScroll()
    {
        yield return StartCoroutine(Scroll.OpenScroll());
    }

    //  巻物を閉じるアニメーションの完了を待つ
    IEnumerator WaitingForClosingScroll()
    {
        yield return StartCoroutine(Scroll.CloseScroll());

        yield return new WaitForSeconds(1f); //  1秒待つ
    }

    //----------------------------------------------------
    //  3Dメニューを回転させる
    //----------------------------------------------------
    private void RotateMenu()
    {
        //  上下の入力を検出する
        Vector2 inputNavigateAxis = navigate.ReadValue<Vector2>();
        verticalInput = inputNavigateAxis.y;

        //  3Dメニューを回転させる
        if (verticalInput > 0 && Rotate3DMenu.Instance.GetComplete())
        {
            Debug.Log("下回転");
            Rotate3DMenu.Instance.TurnMenu(true);

            bCanDecision = false;

            //  インデックスプラス
            if(menuIndex >= (int)BossType.Hakumen)
            {
                menuIndex = (int)BossType.Douji;
            }
            else menuIndex++;

            //  ボタンの選択状態を更新
            SelectButtonByMenuIndex();

            //  ボタンのスケールを更新
            for(int i=0;i<(int)BossType.Max;i++)
            {
                UpdateButtonScale(BossButton[i].gameObject);
            }
        }
        else if (verticalInput < 0 && Rotate3DMenu.Instance.GetComplete())
        {
            Debug.Log("上回転");
            Rotate3DMenu.Instance.TurnMenu(false);

            bCanDecision = false;

            //  インデックスマイナス
            if(menuIndex <= (int)BossType.Douji)
            {
                menuIndex = (int)BossType.Hakumen;
            }
            else menuIndex--;

            //  ボタンの選択状態を更新
            SelectButtonByMenuIndex();

            //  ボタンのスケールを更新
            for(int i=0;i<(int)BossType.Max;i++)
            {
                UpdateButtonScale(BossButton[i].gameObject);
            }
        }
    }

    //----------------------------------------------------
    //  選択されたボタンを大きくする
    //----------------------------------------------------
    private void UpdateButtonScale(GameObject obj)
    {
        float duration = 0.7f;

        if(obj == EventSystem.current.currentSelectedGameObject)
        {
            obj.transform.DOScale(1.2f,duration)
                .SetEase(Ease.InOutElastic)
                .OnComplete(()=>{ bCanDecision = true; });
        }
        else
        {
            obj.transform.DOScale(1.0f,duration)
                .SetEase(Ease.InOutElastic);
        }
    }

    //----------------------------------------------------
    //  未実装ボタンが押された時の処理
    //----------------------------------------------------
    private void OnNotImplementedButtonDown()
    {
        //  不正解SEを再生してリターン
        SoundManager.Instance.PlaySFX(
            (int)AudioChannel.SFX, (int)SFXList.SFX_TITLE_INCORRECT);

        return;
    }

    //----------------------------------------------------
    //  魂バート弾の説明動画を再生する
    //----------------------------------------------------
    private void PlayExplanationMovie()
    {
        if(!Rotate3DMenu.Instance.GetComplete() || !bCanDecision)return;

        //  選択ボタンによって説明動画を再生する
        for(int i=0;i<(int)BossType.Max;i++)
        {
            if(BossButton[i].gameObject == EventSystem.current.currentSelectedGameObject)
            {
                videoPlayer.clip = videoClip[i];
                videoPlayer.Play();
            } 
        }
    }

    //----------------------------------------------------
    //  インデックスでボタンを選択する
    //----------------------------------------------------
    private void SelectButtonByMenuIndex()
    {
        //  インデックスでボタンを選択状態にする
        for(int index=0;index<(int)BossType.Max;index++)
        {
            if(index == menuIndex)
            {
                EventSystem.current.SetSelectedGameObject(BossButton[menuIndex].gameObject);
                
                explanationTextObj[menuIndex].SetActive(true);
            }
        }
    }
}
